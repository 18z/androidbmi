#summary 儲存資訊
#labels tw, preference

我們都知道，一般人身高的變化程度，比起體重的變化程度小的多。

因此就設計一款 BMI 計算程式來說，如果能在使用者第一次輸入身高體重值後，就預先記住身高，那麼下次再次輸入時，便只需要輸入體重。能幫使用者多想一些，減少使用者重複輸入的麻煩，在使用上就更方便了。使用者應該會喜歡這個便利的功能。

= 使用偏好設定 =

打開「src/com/demo/android/bmi/Bmi.java」，在「onCreate」和「onStop」中加入「Preference」(偏好設定)相關的程式碼。完整的程式碼如下：

{{{
public class Bmi extends Activity {
	private static final String TAG = "Bmi";
	public static final String PREF_HEIGHT = "BMI_Height";
	
    /** Called when the activity is first created. */
    @Override
    public void onCreate(Bundle icicle) {
        super.onCreate(icicle);
        setContentView(R.layout.main);
        findViews();
        restorePrefs();
        setListensers();
    }

    // Restore preferences
    private void restorePrefs()
    {
    	SharedPreferences settings = getSharedPreferences(PREF_HEIGHT, 0);
    	String pref_height = settings.getString(PREF_HEIGHT, "");
    	if(pref_height!="")
    	{
    		field_height.setText(pref_height);
    		field_weight.requestFocus();
    	}
    }

......

	@Override
	protected void onStop(){
		super.onStop();
		// Save user preferences. use Editor object to make changes.
		SharedPreferences settings = getSharedPreferences(PREF_HEIGHT, 0);
		settings.edit()
		  .putString(PREF_HEIGHT, field_height.getText().toString())
		  .commit();
	}
}}}

== 講解 ==

=== 取得偏好設定 ===


{{{
    // Restore preferences
    private void restorePrefs()
    {
    	SharedPreferences settings = getSharedPreferences(PREF_HEIGHT, 0);
    	String pref_height = settings.getString(PREF_HEIGHT, "");
    	if(pref_height!="")
    	{
    		field_height.setText(pref_height);
    		field_weight.requestFocus();
        }
    }
}}}

我們在「onCreate」函式中，加入「restorePrefs()」一行 「restorePrefs」呼叫。
並在其後定義一個「restorePrefs」函式如上。

{{{
SharedPreferences settings = getSharedPreferences(PREF_HEIGHT, 0);
}}}
我們宣告了一個偏好設定(SharedPreferences)型別「settings」，並使用「getSharedPreferences」函式來尋找系統中有無已定義的「PREF_HEIGHT」偏好設定參數。如果存在的話，就傳給「settings」。如果沒有的話，就傳 0 給「settings」。

{{{
    String pref_height = settings.getString(PREF_HEIGHT, "");
}}}

我們可以透過「getXXX」函式來從偏好設定(SharedPreferences)讀取不同型別的內容。例如本例中使用「getString」來讀取文字類型的資訊。當「PREF_HEIGHT」偏好設定參數存在時，字串「pref_height」就會得到偏好設定參數的內容。如果不存在「PREF_HEIGHT」這個偏好設定參數時，字串「pref_height」則會得到一個空字串。

{{{
if(pref_height!="")
    	{
    		field_height.setText(pref_height);
            ...
        }
}}}

當「pref_height」字串存在時，我們將 field_height 欄位內容設定成偏好設定參數中取出的值。

{{{
field_weight.requestFocus();
}}}

同時，因為身高欄位已經預先填好了，使用者只需要再填入體重值即可開始計算自己的 BMI 值。但是當成是一執行，預設的焦點欄位（游標）還是停在「身高」欄位上。因此我們在「field_weight」欄位識別符號上，使用「requestFocus」函式，來手動將焦點欄位改到「體重」欄位上。這樣當使用者要輸入時，就更方便了。

我們寫在「restorePrefs」函式中的程式碼，目前都還沒有發生作用。因為我們都還未儲存任何偏好設定哩。接著，我們將在程式中加入儲存偏好設定的程式碼，好能在開啟 Activity 時讀到偏好設定。


=== 儲存偏好設定 ===

{{{
    	@Override
	protected void onStop(){
		super.onStop();
		// Save user preferences. use Editor object to make changes.
		SharedPreferences settings = getSharedPreferences(PREF_HEIGHT, 0);
		settings.edit()
		  .putString(PREF_HEIGHT, field_height.getText().toString())
		  .commit();
	}
}}}

當我們使用「Home」、「Back」按鈕或其他方式離開當前的 Activity 時，我們才把身高的值儲存到偏好設定中。根據上一章[LifeCycle 活動的生命週期]，我們知道離開當前螢幕的最後一個狀態是「Stop」狀態，因此我們覆寫(Overwrite)了「onStop」函式，在其中加入儲存身高偏好設定的程式碼。「super.onStop」的作用是先將原本的「onStop」函式執行一遍。

{{{
SharedPreferences settings = getSharedPreferences(PREF_HEIGHT, 0);
}}}

我們宣告了一個偏好設定(SharedPreferences)型別「settings」，並使用「getSharedPreferences」函式來尋找系統中有無已定義的「PREF_HEIGHT」偏好設定參數。如果存在的話，就傳給「settings」。如果沒有的話，就傳 0 給「settings」。

{{{
    settings.edit()
		  .putString(PREF_HEIGHT, field_height.getText().toString())
		  .commit();
}}}

在此我們串接了三個 settings 擁有的函式：「edit」、「putString」，和「commit」。
要改變偏好設定(SharedPreferences)型別的內容，需要透過「edit」函式來編輯，編輯結束後，要透過「commit」函式來將改變寫到系統中。我們可以透過「putXXX」函式來為偏好設定(SharedPreferences)填入不同型別的內容。例如本例中使用「putString」來寫入文字類型的資訊（讀者也可以試試用 putInt 或 putFloat 函式來直接將身高值儲存成整數或浮點數）。

本例中「putString」函式所執行的動作，是透過「field_height」介面元件識別符號來取得身高的字串後，將字串儲存到「PREF_HEIGHT」所代表的偏好設定參數中。


= 參考資料 =

http://code.google.com/android/devel/data/preferences.html


= 結語 =

這幾章講解了如何撰寫介面、如何撰寫程式碼、如何新增選單，與應用程式如何在多個 Activity 之間切換。了解了這些內容，已足夠我們寫出一般的 Android 應用程式。

Android 是個完整的平台，還有諸多內容值得研究。例如儲存資料、共享內容、網路、瀏覽器、地圖服務、相機、3D、遊戲、通話與簡訊等等進階的主題。

希望讀者能以此小書出發，開發出自己的 Android 程式。

請別吝於留言反應，寫出自己的讀後感言、提出覺得不解的地方、分享自己的經驗。這些都可以協助你更好的學習 Android。如果覺得有那些小地方漏講，也請您直接在該章後加上您的建議。協助其他人，就是協助當初的自己。

== 版權宣告 ==

誠摯地提醒您，本書仍在持續地完善中。本書的文字、圖片、程式碼皆不歡迎轉載，也不可使用於商業用途。
但歡迎您將本書網址 http://code.google.com/p/androidbmi/wiki/IntroAndroid 分享到各網站。

== 填寫讀後問卷 ==

如果您花時間讀了本書，請幫忙填寫只有4題的[http://spreadsheets.google.com/viewform?key=pftJzzqckPIll5elBVuuDWQ 讀後問卷]，以協助改善本書。

< [AndroidIntent 傳送資料到新 Activity]  | [DiveIntoAndroid 回目錄] | [AndroidMarket 發佈到 Android 市場(Market)] >